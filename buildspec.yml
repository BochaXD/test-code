version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "üîÑ Instalando dependencias..."
      - npm ci --silent

      - echo "üîç Verificando librer√≠as deprecadas..."
      - |
        npm ls deprecated --json > deprecated.json || true
        if grep -q '"deprecated":' deprecated.json; then
          echo "‚ùå Se encontraron librer√≠as deprecadas. Revisa 'deprecated.json' para m√°s detalles."
          exit 1
        fi

      - echo "üîç Verificando librer√≠as desactualizadas..."
      - |
        npm outdated --json > outdated.json || true
        if [ -s outdated.json ]; then
          echo "‚ö†Ô∏è Se encontraron librer√≠as desactualizadas. Revisa 'outdated.json' para m√°s detalles."
          exit 1
        fi

  build:
    commands:
      - echo "üß™ Ejecutando pruebas..."
      - npm test
      - echo "üìÅ Verificando directorio 'reports/'..."
      - |
        if [ -d reports ]; then
          echo "‚úÖ El directorio 'reports/' existe."
        else
          echo "‚ö†Ô∏è El directorio 'reports/' no existe."
        fi
      - echo "üìÑ Verificando archivo 'junit.xml'..."
      - |
        if [ -f reports/junit.xml ]; then
          echo "‚úÖ El archivo 'junit.xml' existe."
        else
          echo "‚ö†Ô∏è El archivo 'junit.xml' no existe."
        fi

reports:
  pruebas:
    base-directory: .
    files:
      - 'reports/junit.xml'
    file-format: 'JUNITXML'

  cobertura_codigo:
    base-directory: 'coverage'
    files:
      - 'lcov-report/**/*'
      - 'clover.xml'
    file-format: 'CLOVERXML'
    discard-paths: no

artifacts:
  files:
    - reports/junit.xml
    - coverage/lcov.info
    - coverage/lcov-report/index.html
    - coverage/coverage-final.json
    - dist/**
