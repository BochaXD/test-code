version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo -e "\033[1;34mğŸ”„ Instalando dependencias...\033[0m"
      - npm ci

      # Chequeo de librerÃ­as deprecadas con npm-deprecated-check (usando npx para no instalar global)
      - echo -e "\033[1;34mğŸ” Checando librerÃ­as deprecadas...\033[0m"
      - npx npm-deprecated-check current > deprecated-ndc.txt || true
      - |
        if grep -q 'DEPRECATED' deprecated-ndc.txt; then
          echo -e "\033[1;33mâš ï¸  Se encontraron librerÃ­as DEPRECADAS. Revisa 'deprecated-ndc.txt' para mÃ¡s detalles.\033[0m"
          cat deprecated-ndc.txt
        else
          echo -e "\033[1;32mâœ… No se encontraron librerÃ­as deprecadas.\033[0m"
        fi

      # Chequeo de librerÃ­as desactualizadas
      - echo -e "\033[1;34mğŸ” Checando librerÃ­as desactualizadas...\033[0m"
      - npm outdated > outdated.txt || true
      - |
        if grep -q 'Package' outdated.txt; then
          echo -e "\033[1;33mâš ï¸  Se encontraron librerÃ­as DESACTUALIZADAS. Revisa 'outdated.txt' para mÃ¡s detalles.\033[0m"
          cat outdated.txt
        else
          echo -e "\033[1;32mâœ… Todas las librerÃ­as estÃ¡n actualizadas.\033[0m"
        fi

  build:
    commands:
      - echo -e "\033[1;34mğŸ§ª Ejecutando pruebas y cobertura...\033[0m"
      - npm test
      - echo -e "\033[1;34mğŸ“ Contenido de reports/:\033[0m"
      - ls -la reports || echo "No existe carpeta reports"
      - echo -e "\033[1;34mğŸ“„ Primeras lÃ­neas de junit.xml:\033[0m"
      - cat reports/junit.xml | head || echo "No existe junit.xml"

reports:
  pruebas:
    base-directory: .
    files:
      - 'reports/junit.xml'
    file-format: 'JUNITXML'

  cobertura_codigo:
    base-directory: 'coverage'
    files:
      - 'lcov-report/**/*'
      - 'clover.xml'
    file-format: 'CLOVERXML'
    discard-paths: no

artifacts:
  files:
    - reports/junit.xml
    - coverage/lcov.info
    - coverage/lcov-report/index.html
    - coverage/coverage-final.json
    - dist/**
